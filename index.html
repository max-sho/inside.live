<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>Inside Preview</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#14100E;--bgR:20;--bgG:16;--bgB:14;
  --text:#F5F5F3;--mid:rgba(255,255,255,.65);--dim:rgba(255,255,255,.45);
  --accent:rgb(255,77,0);
  --gl-bg:rgba(255,255,255,.06);--gl-bdr:rgba(255,255,255,.13);
  --r:16px;--r-sm:12px
}
html,body{background:var(--bg);color:var(--text);font-family:'Instrument Sans',-apple-system,sans-serif;-webkit-font-smoothing:antialiased;overflow-x:hidden;height:100%}

/* ── Glass ── */
.g{position:relative;background:var(--gl-bg);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--gl-bdr);border-radius:var(--r);box-shadow:0 .5px 0 0 rgba(255,255,255,.07) inset;overflow:hidden}
.g::before{content:'';position:absolute;inset:0;border-radius:inherit;background:linear-gradient(180deg,rgba(255,255,255,.05) 0%,transparent 50%);pointer-events:none;z-index:1}
.gp{position:relative;background:var(--gl-bg);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--gl-bdr);border-radius:100px;box-shadow:0 .5px 0 0 rgba(255,255,255,.07) inset;overflow:hidden}

/* ── Page ── */
.page{max-width:430px;margin:0 auto;position:relative}

/* ── Hero ── */
.hero{position:fixed;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:100%;overflow:hidden;z-index:0}
.glow{position:absolute;inset:-40%;filter:blur(60px);z-index:0;pointer-events:none;animation:pulse 8s ease-in-out infinite alternate}
@keyframes pulse{0%{opacity:.7;transform:scale(1)}100%{opacity:1;transform:scale(1.05)}}
#vm{position:absolute;inset:0;z-index:1}

/* Canvas injected by SparkJS */
#vm canvas{width:100%!important;height:100%!important;display:block}

/* Promoter logo */
.pid{position:absolute;top:14px;left:50%;transform:translateX(-50%);z-index:3;opacity:.12}
.plogo{width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.08);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.16);overflow:hidden}
.plogo img{width:100%;height:100%;object-fit:cover;display:block}

/* Motion btn */
.mbtn{position:absolute;top:14px;right:14px;z-index:5;width:34px;height:34px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.07);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.12);border-radius:50%;cursor:pointer;color:rgba(255,255,255,.6);padding:0;-webkit-appearance:none}
.mbtn svg{width:16px;height:16px}

/* Hero tap zone */
.hero-tap{position:absolute;inset:0;bottom:42%;z-index:2;cursor:pointer;-webkit-tap-highlight-color:transparent}

/* ── Content ── */
.content{
  position:relative;z-index:3;
  padding:0 16px 16px;
  margin-top:58%;
  display:flex;flex-direction:column;gap:8px;
  transition:opacity .45s cubic-bezier(.16,1,.3,1),transform .45s cubic-bezier(.16,1,.3,1);
}
.content::before{
  content:'';position:absolute;top:0;left:-100vw;right:-100vw;
  height:900px;z-index:-1;pointer-events:none;
  background:linear-gradient(to bottom,
    transparent 0%,
    rgba(var(--bgR),var(--bgG),var(--bgB),.02) 100px,
    rgba(var(--bgR),var(--bgG),var(--bgB),.06) 160px,
    rgba(var(--bgR),var(--bgG),var(--bgB),.14) 220px,
    rgba(var(--bgR),var(--bgG),var(--bgB),.26) 280px,
    rgba(var(--bgR),var(--bgG),var(--bgB),.42) 340px,
    rgba(var(--bgR),var(--bgG),var(--bgB),.60) 400px,
    rgba(var(--bgR),var(--bgG),var(--bgB),.78) 460px,
    rgba(var(--bgR),var(--bgG),var(--bgB),.90) 520px,
    rgba(var(--bgR),var(--bgG),var(--bgB),.97) 580px,
    rgb(var(--bgR),var(--bgG),var(--bgB)) 640px
  );
}
.pull-hint{width:36px;height:3px;border-radius:2px;background:rgba(255,255,255,.15);margin:0 auto 4px;transition:opacity .3s ease}

/* Header */
.evh{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.evh-l{flex:1;min-width:0}
.evp{display:block;font-family:'Space Mono',monospace;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.6);margin-bottom:3px}
.evn{font-size:28px;font-weight:700;letter-spacing:-.8px;line-height:1.1;word-break:break-word}
.dpill{flex-shrink:0;padding:5px 9px;text-align:center;min-width:48px}
.dpill .mo{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);font-weight:700}
.dpill .dy{font-size:20px;font-weight:700;line-height:1.1;margin-top:1px}
.dpill .wd{font-size:10px;color:var(--mid);margin-top:1px}

/* Chips */
.chips{display:flex;gap:5px}
.chip{display:flex;align-items:center;justify-content:center;gap:4px;padding:9px 10px;font-size:11.5px;font-weight:500;color:rgba(255,255,255,.82);white-space:nowrap;font-family:'Instrument Sans',sans-serif;border-width:1px;background:none;flex:1;min-width:0;cursor:pointer;-webkit-appearance:none;transition:all .15s}
.chip.sm{flex:0 0 auto;padding:9px 10px}
.chip:active{background:rgba(255,255,255,.08);transform:scale(.97)}
.chip svg{width:12px;height:12px;flex-shrink:0;opacity:.5}
.chip-t{overflow:hidden;text-overflow:ellipsis}
.chip-a{font-size:9.5px;font-weight:600;color:var(--accent);opacity:.85;margin-left:1px}

/* Lineup */
.lineup{display:flex;flex-wrap:wrap;gap:5px}
.at{padding:5px 11px;border-radius:100px;font-size:12.5px;font-weight:500;color:rgba(255,255,255,.72);background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.09)}
.at.h{font-weight:600;color:rgba(255,255,255,.85)}
.at.l{background:rgba(255,255,255,.02);border-color:rgba(255,255,255,.05);color:rgba(255,255,255,.28);font-size:11.5px}

/* About */
.abt{padding:0}
.abt-h{display:flex;align-items:center;justify-content:space-between;padding:10px 13px;cursor:pointer}
.abt-h span{font-size:12px;font-weight:500;color:rgba(255,255,255,.45)}
.abt-arr{width:16px;height:16px;color:rgba(255,255,255,.3);transition:transform .3s cubic-bezier(.16,1,.3,1)}
.abt.open .abt-arr{transform:rotate(180deg)}
.abt-body{max-height:0;overflow:hidden;transition:max-height .35s cubic-bezier(.16,1,.3,1),opacity .3s ease;opacity:0;padding:0 13px}
.abt.open .abt-body{max-height:300px;opacity:1;padding:0 13px 10px}
.abt-d{font-size:13px;line-height:1.5;color:rgba(255,255,255,.5);margin-bottom:6px}
.dr{display:flex;justify-content:space-between;align-items:center;padding:3px 0}
.dl{font-size:12px;color:rgba(255,255,255,.5)}
.dv{font-size:12px;font-weight:600;color:rgba(255,255,255,.78)}

/* CTA */
.cta{display:block;width:100%;padding:15px 16px;background:rgba(255,77,0,.15);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,77,0,.25);color:#fff;border-radius:var(--r);font-family:'Space Mono',monospace;font-size:13px;font-weight:700;letter-spacing:3px;text-transform:uppercase;text-align:center;text-decoration:none;cursor:pointer;position:relative;overflow:hidden;transition:all .2s ease}
.cta:active{transform:scale(.985);background:rgba(255,77,0,.22)}
.cta::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.05) 0%,transparent 50%);pointer-events:none}

/* Past events */
.pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.pcard{border-radius:var(--r-sm);overflow:hidden;position:relative;aspect-ratio:3/4;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);cursor:pointer;transition:transform .25s cubic-bezier(.16,1,.3,1)}
.pcard:active{transform:scale(.95)}
.pcard img{width:100%;height:100%;object-fit:cover;display:block}
.pcard-bg{width:100%;height:100%}
.pcard-i{position:absolute;bottom:0;left:0;right:0;padding:20px 7px 6px;background:linear-gradient(to top,rgba(0,0,0,.8) 0%,transparent 100%)}
.pcard-t{font-size:10px;font-weight:600;color:var(--text);line-height:1.2}
.pcard-d{font-size:9px;color:var(--mid);margin-top:1px}

/* Footer */
.ft{padding:16px 16px 36px;text-align:center}
.ft-t{font-size:10.5px;color:var(--dim);letter-spacing:.5px}
.ft-t a{color:var(--mid);text-decoration:none;font-weight:600}

/* ── Cinema bar ── */
.cbar{
  position:fixed;bottom:0;left:50%;
  transform:translateX(-50%) translateY(100%);
  width:100%;max-width:430px;z-index:60;
  padding:20px;padding-bottom:24px;
  background:rgba(var(--bgR),var(--bgG),var(--bgB),.75);
  backdrop-filter:blur(30px);-webkit-backdrop-filter:blur(30px);
  border-top:1px solid rgba(255,255,255,.06);
  transition:transform .5s cubic-bezier(.16,1,.3,1);
  display:flex;flex-direction:column;align-items:center;gap:12px;text-align:center;
}
.cbar.on{transform:translateX(-50%) translateY(0)}
.cbar-label{font-family:'Space Mono',monospace;font-size:10px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,.45)}
.cbar-title{font-size:22px;font-weight:700;letter-spacing:-.5px;line-height:1.1}
.cbar-cta{display:block;width:100%;padding:13px;text-align:center;background:rgba(255,77,0,.18);border:1px solid rgba(255,77,0,.28);color:#fff;border-radius:var(--r);font-family:'Space Mono',monospace;font-size:12px;font-weight:700;letter-spacing:3px;text-transform:uppercase;text-decoration:none;cursor:pointer}
.cbar-cta:active{transform:scale(.985);background:rgba(255,77,0,.26)}
.cbar-home{display:none;width:40px;height:40px;align-items:center;justify-content:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:50%;cursor:pointer;color:rgba(255,255,255,.55);padding:0;-webkit-appearance:none}
.cbar-home svg{width:18px;height:18px}
.cbar-date{font-family:'Space Mono',monospace;font-size:11px;letter-spacing:1px;color:rgba(255,255,255,.4);margin-top:-4px}
.cbar[data-mode="cinema"] .cbar-cta{display:block}
.cbar[data-mode="cinema"] .cbar-home{display:none}
.cbar[data-mode="cinema"] .cbar-date{display:none}
.cbar[data-mode="memory"] .cbar-cta{display:none}
.cbar[data-mode="memory"] .cbar-home{display:flex}
.cbar[data-mode="memory"] .cbar-date{display:block}

/* Sticky CTA */
.sticky{position:fixed;bottom:0;left:50%;transform:translateX(-50%) translateY(100%);width:100%;max-width:430px;z-index:50;padding:10px 16px 14px;background:rgba(var(--bgR),var(--bgG),var(--bgB),.88);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.06);transition:transform .3s cubic-bezier(.16,1,.3,1)}
.sticky.on{transform:translateX(-50%) translateY(0)}
.sticky-b{display:block;width:100%;padding:13px;text-align:center;background:rgba(255,77,0,.2);border:1px solid rgba(255,77,0,.3);color:#fff;border-radius:var(--r);font-family:'Space Mono',monospace;font-size:12px;font-weight:700;letter-spacing:3px;text-transform:uppercase;text-decoration:none;cursor:pointer}

/* ── Page states ── */
.page.cinema .content,.page.memory .content{opacity:0;transform:translateY(60px);pointer-events:none;transition:opacity .4s,transform .4s}
.page.cinema .pull-hint,.page.memory .pull-hint{opacity:0}
.page.cinema .sticky,.page.memory .sticky{transform:translateX(-50%) translateY(100%)!important}

/* ── Entrance ── */
.content>*{opacity:0;transform:translateY(8px);animation:up .35s ease forwards}
.content>*:nth-child(1){animation-delay:.05s}
.content>*:nth-child(2){animation-delay:.1s}
.content>*:nth-child(3){animation-delay:.14s}
.content>*:nth-child(4){animation-delay:.18s}
.content>*:nth-child(5){animation-delay:.22s}
.content>*:nth-child(6){animation-delay:.26s}
.content>*:nth-child(7){animation-delay:.30s}
.content>*:nth-child(8){animation-delay:.34s}
@keyframes up{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* ── No viewer fallback ── */
.no-viewer{position:fixed;inset:0;z-index:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;pointer-events:none}
.no-viewer-txt{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.15)}
.no-viewer-sub{font-size:11px;color:rgba(255,255,255,.1)}
</style>
</head>
<body>
<div class="page" id="page">

  <!-- HERO -->
  <div class="hero" id="hero">
    <div class="glow" id="glow" style="background:radial-gradient(ellipse 80% 70% at 50% 50%,rgba(180,60,40,.30) 0%,rgba(180,60,40,.18) 22%,rgba(180,60,40,.07) 46%,transparent 90%)"></div>
    <div id="vm"></div>
    <div class="pid" id="pid"><div class="plogo"><img id="pimg" src="" alt=""/></div></div>
    <button class="mbtn" id="mbtn" aria-label="Enable motion">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
    </button>
    <div class="hero-tap" id="heroTap"></div>
  </div>

  <!-- CONTENT -->
  <div class="content" id="content">
    <div class="pull-hint"></div>

    <div class="evh">
      <div class="evh-l">
        <span class="evp" id="evp">RECESS PRESENTS</span>
        <h1 class="evn" id="evn">Homecoming</h1>
      </div>
      <div class="dpill g" id="dp">
        <div class="mo" id="dmo">MAR</div>
        <div class="dy" id="ddy">15</div>
        <div class="wd" id="dwd">Sat</div>
      </div>
    </div>

    <div class="chips">
      <button class="chip gp" id="tcChip"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span class="chip-t" id="tcTxt">22:00 – 04:00</span><span class="chip-a">Add</span></button>
      <button class="chip gp" id="vcChip"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><span class="chip-t" id="vcTxt">Venue MOT</span></button>
      <button class="chip sm gp" id="mcChip" aria-label="Music"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></button>
      <button class="chip sm gp" id="scChip" aria-label="Share"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg></button>
    </div>

    <div class="abt g" id="abt">
      <div class="abt-h" id="abtH">
        <span>About this event</span>
        <svg class="abt-arr" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="abt-body">
        <div class="lineup" id="lu">
          <span class="at h">DJ Jojo</span><span class="at h">Sef Kombo</span><span class="at">Kxngs</span>
        </div>
        <p class="abt-d" id="abtD">An evening of Afrobeats, Amapiano & good energy.</p>
        <div id="dets">
          <div class="dr"><span class="dl">Age</span><span class="dv" id="dAge">18+</span></div>
          <div class="dr"><span class="dl">Dress code</span><span class="dv" id="dDrs">Smart casual</span></div>
          <div class="dr"><span class="dl">Last entry</span><span class="dv" id="dEnt">01:00</span></div>
        </div>
      </div>
    </div>

    <a href="#" class="cta" id="cta" onclick="return false">GET TICKETS</a>

    <div id="pastSec">
      <div class="pgrid" id="pgrid">
        <div class="pcard"><div class="pcard-bg" style="background:linear-gradient(145deg,hsla(0,60%,50%,.15),hsla(0,30%,8%,.95))"></div><div class="pcard-i"><div class="pcard-t">NYE Special</div><div class="pcard-d">Dec 31</div></div></div>
        <div class="pcard"><div class="pcard-bg" style="background:linear-gradient(145deg,hsla(220,60%,50%,.15),hsla(220,30%,8%,.95))"></div><div class="pcard-i"><div class="pcard-t">Detour x Yam</div><div class="pcard-d">Nov 23</div></div></div>
        <div class="pcard"><div class="pcard-bg" style="background:linear-gradient(145deg,hsla(140,60%,50%,.15),hsla(140,30%,8%,.95))"></div><div class="pcard-i"><div class="pcard-t">Summer Close</div><div class="pcard-d">Sep 14</div></div></div>
      </div>
    </div>

    <div class="ft"><div class="ft-t">Powered by <a href="#">inside.live</a></div></div>
  </div>
</div>

<!-- Cinema bar -->
<div class="cbar" id="cbar" data-mode="cinema">
  <span class="cbar-label" id="cbarLabel">RECESS PRESENTS</span>
  <div class="cbar-title" id="cbarTitle">Homecoming</div>
  <span class="cbar-date" id="cbarDate"></span>
  <a href="#" class="cbar-cta" id="cbarCta" onclick="return false">GET TICKETS</a>
  <button class="cbar-home" id="cbarHome" aria-label="Back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></button>
</div>

<!-- Sticky CTA -->
<div class="sticky" id="sticky">
  <a href="#" class="sticky-b" id="sBtn" onclick="return false">GET TICKETS</a>
</div>

<!-- No viewer fallback -->
<div class="no-viewer" id="noViewer">
  <div class="no-viewer-txt">drop .sog to preview</div>
  <div class="no-viewer-sub">viewer activates on asset load</div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/",
    "@sparkjsdev/spark": "https://cdn.jsdelivr.net/npm/@sparkjsdev/spark@0.1.37/dist/spark.module.js"
  }
}
</script>
<script type="module">
// ═══════════════════════════════════════════
// INSIDE PREVIEW — receives config from editor via postMessage
// ═══════════════════════════════════════════
const $=id=>document.getElementById(id);
let mode='info'; // info | cinema | memory
let viewerReady=false;
let viewerInstance=null; // will hold SparkJS objects

// ── Mode switching ──
function setMode(m){
  mode=m;
  const page=$('page');
  page.classList.remove('info','cinema','memory');
  page.classList.add(m);

  const cbar=$('cbar');
  const sticky=$('sticky');

  if(m==='info'){
    cbar.classList.remove('on');
    // Show sticky if scrolled
    checkSticky();
  } else if(m==='cinema'){
    cbar.dataset.mode='cinema';
    cbar.classList.add('on');
    sticky.classList.remove('on');
  } else if(m==='memory'){
    cbar.dataset.mode='memory';
    cbar.classList.add('on');
    sticky.classList.remove('on');
  }
}

// ── Sticky CTA visibility ──
let stickyVisible=false;
function checkSticky(){
  if(mode!=='info')return;
  const ctaEl=$('cta');
  if(!ctaEl)return;
  const rect=ctaEl.getBoundingClientRect();
  const should=rect.bottom<0;
  if(should!==stickyVisible){
    stickyVisible=should;
    $('sticky').classList.toggle('on',should);
  }
}
window.addEventListener('scroll',checkSticky,{passive:true});

// ── About toggle ──
$('abtH').addEventListener('click',()=>$('abt').classList.toggle('open'));

// ── Hero tap → cinema ──
$('heroTap').addEventListener('click',()=>{
  if(mode==='info'){
    setMode('cinema');
    window.parent.postMessage({type:'mode-changed',mode:'cinema'},'*');
  }
});

// ── Cinema bar home → info ──
$('cbarHome').addEventListener('click',()=>{
  setMode('info');
  window.parent.postMessage({type:'mode-changed',mode:'info'},'*');
});

// ── Fill event data ──
function fillEvent(e){
  if(!e)return;
  $('evp').textContent=e.promoter||'';
  $('evn').textContent=e.name||'';
  if(e.promoterLogo){$('pimg').src=e.promoterLogo;$('pid').style.display='';}
  else{$('pid').style.display='none';}

  // Date
  if(e.date){
    try{
      const d=new Date(e.date+'T00:00:00');
      const mos='JAN FEB MAR APR MAY JUN JUL AUG SEP OCT NOV DEC'.split(' ');
      const wds='Sun Mon Tue Wed Thu Fri Sat'.split(' ');
      $('dmo').textContent=mos[d.getMonth()];
      $('ddy').textContent=d.getDate();
      $('dwd').textContent=wds[d.getDay()];
    }catch(err){}
  }

  // Chips
  if(e.time)$('tcTxt').textContent=(e.time.start||'')+'–'+(e.time.end||'');
  if(e.venue)$('vcTxt').textContent=e.venue.name||e.venue||'';

  // Lineup
  if(e.lineup?.length){
    const lu=$('lu');lu.innerHTML='';
    e.lineup.forEach(a=>{
      const s=document.createElement('span');
      s.className='at'+(a.headliner?' h':'')+(a.locked?' l':'');
      s.textContent=a.name;lu.appendChild(s);
    });
  }

  // About
  if(e.description)$('abtD').textContent=e.description;
  if(e.age)$('dAge').textContent=e.age;
  if(e.dressCode)$('dDrs').textContent=e.dressCode;
  if(e.lastEntry)$('dEnt').textContent=e.lastEntry;

  // Past events
  if(e.pastEvents?.length){
    const pg=$('pgrid');pg.innerHTML='';
    const hues=[0,220,140];
    e.pastEvents.forEach((pe,i)=>{
      const c=document.createElement('div');c.className='pcard';
      const h=hues[i%3];
      const hasImg=pe.image&&pe.image.length>0;
      c.innerHTML=(hasImg
        ?'<img src="'+pe.image+'" alt="'+pe.title+'"/>'
        :'<div class="pcard-bg" style="background:linear-gradient(145deg,hsla('+h+',60%,50%,.15),hsla('+h+',30%,8%,.95))"></div>'
      )+'<div class="pcard-i"><div class="pcard-t">'+(pe.title||'')+'</div><div class="pcard-d">'+(pe.date||'')+'</div></div>';
      pg.appendChild(c);
    });
  }

  // Cinema bar
  $('cbarLabel').textContent=e.promoter||'';
  $('cbarTitle').textContent=e.name||'';

  // Accent colour
  if(e.accentColorOverride){
    document.documentElement.style.setProperty('--accent',e.accentColorOverride);
  }

  // Glow color from accent
  updateGlow();
}

function updateGlow(){
  const accent=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  // Use a muted version for glow
  $('glow').style.background=`radial-gradient(ellipse 80% 70% at 50% 50%,${accent.replace('rgb','rgba').replace(')',',0.25)')} 0%,${accent.replace('rgb','rgba').replace(')',',0.12)')} 30%,transparent 80%)`;
}

// ═══════════════════════════════════════════
// SPARKJS VIEWER
// ═══════════════════════════════════════════
let THREE_mod=null, Spark_mod=null;
let sogUrl=null, bgUrl=null;

async function loadModules(){
  if(THREE_mod)return;
  try{
    THREE_mod=await import('three');
    Spark_mod=await import('@sparkjsdev/spark');
    console.log('✅ SparkJS modules loaded');
  }catch(e){
    console.warn('SparkJS load failed:',e);
  }
}

async function initViewer(config){
  if(!sogUrl){console.log('No .sog URL yet');return;}
  await loadModules();
  if(!THREE_mod||!Spark_mod)return;

  const {Scene,PerspectiveCamera,WebGLRenderer,Spherical,Vector3,Color,CanvasTexture}=THREE_mod;
  const {SplatMesh,SparkRenderer,SplatEdit,SplatEditSdf,SplatEditSdfType,SplatEditRgbaBlendMode,dyno}=Spark_mod;

  // Cleanup previous
  if(viewerInstance){
    try{viewerInstance.renderer.dispose();}catch(e){}
    const oldCanvas=$('vm').querySelector('canvas');
    if(oldCanvas)oldCanvas.remove();
  }

  const vm=$('vm');
  const w=vm.clientWidth||window.innerWidth;
  const h=vm.clientHeight||window.innerHeight;

  const vc=config||{};
  const cam=vc.camera||{};

  const scene=new Scene();
  const camera=new PerspectiveCamera(cam.fov||50,w/h,0.1,100);
  const renderer=new WebGLRenderer({antialias:false,alpha:false});
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.setSize(w,h);
  renderer.setClearColor(0x14100E,1);
  vm.appendChild(renderer.domElement);

  const spark=new SparkRenderer({renderer,focalDistance:cam.radius||2.5,apertureAngle:0,blurAmount:0});
  scene.add(spark);

  // ── Background ──
  if(bgUrl){
    const bgCanvas=document.createElement('canvas');
    const bgCtx=bgCanvas.getContext('2d');
    const bgImg=new Image();
    bgImg.crossOrigin='anonymous';
    bgImg.onload=()=>{
      const maxDim=512;
      const aspect=w/h;
      let cw,ch;
      if(aspect>1){cw=maxDim;ch=Math.round(maxDim/aspect);}
      else{ch=maxDim;cw=Math.round(maxDim*aspect);}
      bgCanvas.width=cw;bgCanvas.height=ch;

      // Cover crop
      const iw=bgImg.naturalWidth,ih=bgImg.naturalHeight;
      const imgAspect=iw/ih;
      let sx,sy,sw,sh;
      if(imgAspect>aspect){sh=ih;sw=ih*aspect;sx=(iw-sw)/2;sy=0;}
      else{sw=iw;sh=iw/aspect;sx=0;sy=(ih-sh)/2;}
      bgCtx.drawImage(bgImg,sx,sy,sw,sh,0,0,cw,ch);

      // Simple blur via multiple draws
      const bg=vc.background||{};
      const blurR=Math.round((bg.blur||3)*(cw/512));
      if(blurR>0){
        bgCtx.filter=`blur(${blurR}px)`;
        bgCtx.drawImage(bgCanvas,0,0);bgCtx.drawImage(bgCanvas,0,0);bgCtx.drawImage(bgCanvas,0,0);
        bgCtx.filter='none';
      }

      // Brightness/saturation via pixel manipulation
      const br=bg.brightness??0.7;
      const sat=bg.saturation??0.5;
      const imgData=bgCtx.getImageData(0,0,cw,ch);
      const d=imgData.data;
      for(let i=0;i<d.length;i+=4){
        let r=d[i]*br,g=d[i+1]*br,b=d[i+2]*br;
        const gray=0.299*r+0.587*g+0.114*b;
        d[i]=Math.min(255,Math.max(0,gray+(r-gray)*sat));
        d[i+1]=Math.min(255,Math.max(0,gray+(g-gray)*sat));
        d[i+2]=Math.min(255,Math.max(0,gray+(b-gray)*sat));
      }
      bgCtx.putImageData(imgData,0,0);

      const tex=new CanvasTexture(bgCanvas);
      scene.background=tex;
    };
    bgImg.src=bgUrl;
  } else {
    scene.background=new Color(0x14100E);
  }

  // ── Dyno effect uniforms ──
  const fxTime=dyno.dynoFloat(0);
  const fxDrift=dyno.dynoFloat(0);
  const fxDriftScale=dyno.dynoFloat(2.5);
  const fxDriftSpd=dyno.dynoFloat(0.4);
  const fxDriftTurb=dyno.dynoFloat(2);
  const fxDriftYDamp=dyno.dynoFloat(0.3);
  const fxDriftFade=dyno.dynoFloat(0.5);
  const fxWarmth=dyno.dynoFloat(0);
  const fxVqX=dyno.dynoFloat(0),fxVqY=dyno.dynoFloat(0),fxVqZ=dyno.dynoFloat(0),fxVqW=dyno.dynoFloat(1);

  // ── Load splat ──
  const splat=new SplatMesh({
    url:sogUrl,
    onLoad:(mesh)=>{
      console.log('✅ Splat loaded:',mesh.numSplats,'splats');
      $('noViewer').style.display='none';
      viewerReady=true;
      // Start reveal
      revealStart=performance.now()/1000;
    },
  });
  splat.quaternion.set(1,0,0,0);
  splat.opacity=0;
  scene.add(splat);

  // ── Minimal objectModifier (drift + warmth only for preview perf) ──
  splat.objectModifier=dyno.dynoBlock(
    {gsplat:dyno.Gsplat},
    {gsplat:dyno.Gsplat},
    ({gsplat})=>{
      const d=new dyno.Dyno({
        inTypes:{gsplat:dyno.Gsplat,t:'float',drift:'float',driftScale:'float',driftSpd:'float',driftTurb:'float',driftYDamp:'float',driftFade:'float',warmth:'float'},
        outTypes:{gsplat:dyno.Gsplat},
        globals:()=>[dyno.unindent(`
          float pnoise3(vec3 p){vec3 i=floor(p);vec3 f=fract(p);f=f*f*(3.0-2.0*f);
          float n000=fract(sin(dot(i,vec3(127.1,311.7,74.7)))*43758.5453);
          float n100=fract(sin(dot(i+vec3(1,0,0),vec3(127.1,311.7,74.7)))*43758.5453);
          float n010=fract(sin(dot(i+vec3(0,1,0),vec3(127.1,311.7,74.7)))*43758.5453);
          float n110=fract(sin(dot(i+vec3(1,1,0),vec3(127.1,311.7,74.7)))*43758.5453);
          float n001=fract(sin(dot(i+vec3(0,0,1),vec3(127.1,311.7,74.7)))*43758.5453);
          float n101=fract(sin(dot(i+vec3(1,0,1),vec3(127.1,311.7,74.7)))*43758.5453);
          float n011=fract(sin(dot(i+vec3(0,1,1),vec3(127.1,311.7,74.7)))*43758.5453);
          float n111=fract(sin(dot(i+vec3(1,1,1),vec3(127.1,311.7,74.7)))*43758.5453);
          return mix(mix(mix(n000,n100,f.x),mix(n010,n110,f.x),f.y),mix(mix(n001,n101,f.x),mix(n011,n111,f.x),f.y),f.z);}
          vec3 pcurl(vec3 p){float e=0.05;float inv=1.0/(2.0*e);
          float a=pnoise3(p+vec3(0,e,0));float b=pnoise3(p-vec3(0,e,0));
          float c=pnoise3(p+vec3(0,0,e)+vec3(31.4,0,0));float dd=pnoise3(p-vec3(0,0,e)+vec3(31.4,0,0));
          float ee2=pnoise3(p+vec3(e,0,0)+vec3(31.4,0,0));float ff=pnoise3(p-vec3(e,0,0)+vec3(31.4,0,0));
          float g=pnoise3(p+vec3(0,e,0)+vec3(0,73.1,0));float h=pnoise3(p-vec3(0,e,0)+vec3(0,73.1,0));
          float ii2=pnoise3(p+vec3(e,0,0)+vec3(0,73.1,0));float jj=pnoise3(p-vec3(e,0,0)+vec3(0,73.1,0));
          float k=pnoise3(p+vec3(0,0,e));float l=pnoise3(p-vec3(0,0,e));
          return vec3((g-h)*inv-(c-dd)*inv,(k-l)*inv-(ii2-jj)*inv,(ee2-ff)*inv-(a-b)*inv);}
          vec3 cosPal(float t){return vec3(0.5)+vec3(0.5)*cos(6.283*(vec3(1.0)*t+vec3(0.0,0.1,0.2)));}
        `)],
        statements:({inputs,outputs})=>dyno.unindentLines(`
          ${outputs.gsplat}=${inputs.gsplat};
          vec3 pos=${inputs.gsplat}.center;
          float dist=length(pos);
          float edgeMask=mix(1.0,smoothstep(0.2,1.5,dist),${inputs.driftFade});
          vec3 disp=pcurl(pos*${inputs.driftScale}+${inputs.t}*${inputs.driftSpd});
          disp.y*=(1.0-${inputs.driftYDamp});
          ${outputs.gsplat}.center=pos+disp*${inputs.drift}*edgeMask;
          vec3 warmTint=cosPal(dist*0.15+0.3);
          ${outputs.gsplat}.rgba.rgb=mix(${inputs.gsplat}.rgba.rgb,${inputs.gsplat}.rgba.rgb*warmTint,${inputs.warmth}*dist);
        `),
      });
      gsplat=d.apply({gsplat,t:fxTime,drift:fxDrift,driftScale:fxDriftScale,driftSpd:fxDriftSpd,driftTurb:fxDriftTurb,driftYDamp:fxDriftYDamp,driftFade:fxDriftFade,warmth:fxWarmth}).gsplat;
      return {gsplat};
    }
  );
  try{splat.updateGenerator();}catch(e){console.warn('Dyno compile:',e);splat.objectModifier=null;splat.updateGenerator();}

  // ── Distance fade ──
  const fadeSphere=new SplatEditSdf({type:SplatEditSdfType.SPHERE,radius:5,opacity:0,color:new THREE_mod.Color(1,1,1),invert:true});
  const fadeEdit=new SplatEdit({rgbaBlendMode:SplatEditRgbaBlendMode.MULTIPLY,softEdge:1.2,sdfs:[fadeSphere]});
  scene.add(fadeEdit);

  // ── Camera orbit ──
  const target=new Vector3(cam.targetX||0,cam.targetY||0,cam.targetZ||0);
  let baseTheta=0,basePhi=Math.PI/2,baseRadius=cam.radius||2.5;
  const spherical=new Spherical();

  // ── Touch drag ──
  let isDragging=false,touchStartX=0,touchStartY=0,thetaStart=0,phiStart=0;
  let velT=0,velP=0,lastInteract=0;
  const canvas=renderer.domElement;

  canvas.addEventListener('pointerdown',e=>{
    isDragging=true;touchStartX=e.clientX;touchStartY=e.clientY;
    thetaStart=baseTheta;phiStart=basePhi;velT=0;velP=0;
    lastInteract=performance.now()/1000;
  });
  canvas.addEventListener('pointermove',e=>{
    if(!isDragging)return;
    const dx=(e.clientX-touchStartX)/w;
    const dy=(e.clientY-touchStartY)/h;
    baseTheta=thetaStart-dx*2.5;
    basePhi=phiStart+dy*1.5;
    lastInteract=performance.now()/1000;
  });
  canvas.addEventListener('pointerup',()=>{isDragging=false;});

  // ── Reveal ──
  let revealStart=-1,revealed=false;
  const revealDur=vc.reveal?.duration||2.0;

  // ── Render loop ──
  const startTime=performance.now()/1000;
  const orbitPos=new Vector3();

  renderer.setAnimationLoop(()=>{
    const now=performance.now()/1000;
    const time=now-startTime;
    fxTime.value=time;
    splat.updateVersion();

    // Reveal
    if(revealStart>0&&!revealed){
      const t=Math.min((now-revealStart)/revealDur,1);
      splat.opacity=1-Math.pow(1-t,3);
      if(t>=1)revealed=true;
    }

    // Orbit clamp
    const hRad=(cam.hRange||30)*Math.PI/180;
    const vMin=(cam.vMin||60)*Math.PI/180;
    const vMax=(cam.vMax||100)*Math.PI/180;
    const ft=Math.max(-hRad,Math.min(hRad,baseTheta));
    const fp=Math.max(vMin,Math.min(vMax,basePhi));

    // Idle sway
    let idleT=0,idleP=0;
    const gap=time-lastInteract;
    if(!isDragging&&gap>2){
      const f=Math.min((gap-2)/1.5,1);
      idleT=Math.sin(time*0.15)*0.04*f;
      idleP=Math.sin(time*0.105+1.2)*0.02*f;
    }

    spherical.set(baseRadius,fp+idleP,ft+idleT);
    spherical.makeSafe();
    orbitPos.setFromSpherical(spherical).add(target);
    orbitPos.y+=(cam.height||0);
    camera.position.copy(orbitPos);
    camera.lookAt(target);

    // View quat for matcap
    const cq=camera.quaternion;
    fxVqX.value=-cq.x;fxVqY.value=-cq.y;fxVqZ.value=-cq.z;fxVqW.value=cq.w;

    renderer.render(scene,camera);
  });

  // Store for config updates
  viewerInstance={renderer,camera,scene,spark,splat,splat,fadeSphere,fadeEdit,target,
    fxDrift,fxDriftScale,fxDriftSpd,fxDriftTurb,fxDriftYDamp,fxDriftFade,fxWarmth,
    cam,baseRadius:()=>baseRadius,setRadius:v=>{baseRadius=v;},
    setHRange:v=>{cam.hRange=v;},setVMin:v=>{cam.vMin=v;},setVMax:v=>{cam.vMax=v;},
    setTargetX:v=>{cam.targetX=v;target.x=v;},setTargetY:v=>{cam.targetY=v;target.y=v;},setTargetZ:v=>{cam.targetZ=v;target.z=v;},
    setHeight:v=>{cam.height=v;},
    triggerReveal:()=>{revealStart=performance.now()/1000;revealed=false;splat.opacity=0;},
  };

  // Apply initial effects config
  applyEffectsConfig(vc);

  // Resize handler
  const onResize=()=>{
    const nw=vm.clientWidth||window.innerWidth;
    const nh=vm.clientHeight||window.innerHeight;
    camera.aspect=nw/nh;camera.updateProjectionMatrix();
    renderer.setSize(nw,nh);
  };
  window.addEventListener('resize',onResize);
}

// ── Apply effects config to live viewer ──
function applyEffectsConfig(vc){
  if(!viewerInstance)return;
  const vi=viewerInstance;
  const fx=vc.effects||{};

  // Drift
  if(fx.drift){
    vi.fxDrift.value=fx.drift.enabled?(fx.drift.amount||0):0;
    vi.fxDriftScale.value=fx.drift.scale||2.5;
    vi.fxDriftSpd.value=fx.drift.speed||0.4;
    vi.fxDriftTurb.value=fx.drift.turbulence||2;
    vi.fxDriftYDamp.value=fx.drift.yDamping||0.3;
    vi.fxDriftFade.value=fx.drift.edgeFade||0.5;
  }
  // Warmth
  if(fx.warmth){
    vi.fxWarmth.value=fx.warmth.enabled?(fx.warmth.tint||0):0;
  }

  // Camera
  const cam=vc.camera||{};
  if(cam.radius!==undefined){vi.setRadius(cam.radius);}
  if(cam.fov!==undefined){vi.camera.fov=cam.fov;vi.camera.updateProjectionMatrix();}
  if(cam.height!==undefined)vi.setHeight(cam.height);
  if(cam.hRange!==undefined)vi.setHRange(cam.hRange);
  if(cam.vMin!==undefined)vi.setVMin(cam.vMin);
  if(cam.vMax!==undefined)vi.setVMax(cam.vMax);
  if(cam.targetX!==undefined)vi.setTargetX(cam.targetX);
  if(cam.targetY!==undefined)vi.setTargetY(cam.targetY);
  if(cam.targetZ!==undefined)vi.setTargetZ(cam.targetZ);

  // Distance fade
  const df=vc.distanceFade||{};
  if(df.softEdge!==undefined)vi.fadeEdit.softEdge=df.softEdge;

  // Splat transform
  const st=vc.splatTransform||{};
  if(st.posX!==undefined)vi.splat.position.set(st.posX||0,st.posY||0,st.posZ||0);
  if(st.scale!==undefined)vi.splat.scale.setScalar(st.scale||1);
}

// ═══════════════════════════════════════════
// POSTMESSAGE HANDLER
// ═══════════════════════════════════════════
window.addEventListener('message',async(e)=>{
  if(!e.data||!e.data.type)return;
  const msg=e.data;

  switch(msg.type){
    case 'config':
      // Full config: event + viewer
      if(msg.event)fillEvent(msg.event);
      if(msg.viewer){
        // If we have a sog and viewer isn't ready, init it
        if(sogUrl&&!viewerInstance){
          await initViewer(msg.viewer);
        } else if(viewerInstance){
          applyEffectsConfig(msg.viewer);
        }
      }
      break;

    case 'event-update':
      if(msg.event)fillEvent(msg.event);
      break;

    case 'viewer-update':
      if(msg.viewer&&viewerInstance){
        applyEffectsConfig(msg.viewer);
      }
      break;

    case 'asset':
      if(msg.assetType==='sog'){
        sogUrl=msg.url;
        $('noViewer').querySelector('.no-viewer-txt').textContent='loading .sog…';
        // Init or re-init viewer
        await initViewer(msg.viewer||{});
      }
      if(msg.assetType==='background'){
        bgUrl=msg.url;
        // Re-init viewer with new bg
        if(sogUrl)await initViewer(msg.viewer||{});
      }
      if(msg.assetType==='logo'){
        $('pimg').src=msg.url;
        $('pid').style.display='';
      }
      break;

    case 'set-mode':
      setMode(msg.mode);
      break;

    case 'trigger-reveal':
      if(viewerInstance)viewerInstance.triggerReveal();
      break;
  }
});

// ── Signal ready ──
window.parent.postMessage({type:'preview-ready'},'*');
</script>
</body>
</html>
